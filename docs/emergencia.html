<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Emergencia activa | VidaLink</title>
  <link rel="icon" type="image/png" href="RECURSOS/vidalink.png">
  <link rel="stylesheet" href="CSS/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>

  <nav class="navbar bg-body-tertiary navbar-compact">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <img src="RECURSOS/logo.png" alt="Logo" width="200" height="55">
      </div>
    </div>
  </nav>

  <main class="container py-5">

    <!-- CARD AMARILLA CON RADAR -->
    <div class="alert alert-warning text-center p-4 mb-4 shadow-sm">
      <div class="radar-container mx-auto mb-3">
        <div class="radar"></div>
      </div>

      <h5 class="fw-bold text-dark">Buscando voluntarios cercanos‚Ä¶</h5>
      <p class="mb-1 text-dark">Se ha enviado la alerta a voluntarios disponibles</p>
      <small id="tiempoActivo" class="text-muted"></small>
    </div>

    <!-- UBICACI√ìN -->
    <div class="card mb-4 shadow-sm">
      <div class="card-body text-center">
        <h6 class="fw-bold text-danger">Ubicaci√≥n de emergencia</h6>
        <p id="coords" class="mb-0 fw-bold fs-5 text-primary">Obteniendo ubicaci√≥n...</p>
      </div>
    </div>

    <!-- BOTONES PRINCIPALES -->
    <div class="d-grid gap-3 mb-5">
      <button class="btn btn-danger btn-lg fw-bold" onclick="abrirGuia()">
        Ver Gu√≠a de Primeros Auxilios
      </button>

      <button class="btn btn-success btn-lg fw-bold" id="btnAbrirChat">
        üí¨ Conversar con el voluntario
      </button>

      <button class="btn btn-outline-secondary btn-lg" onclick="cancelarEmergencia()">
        Cancelar Emergencia
      </button>
    </div>

  </main>

  <!-- MODAL GU√çA DE PRIMEROS AUXILIOS -->
  <div class="modal fade" id="modalGuia" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="tituloModal">Gu√≠as de Primeros Auxilios</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="contenidoModal">
          <!-- Se llena con JS -->
        </div>
      </div>
    </div>
  </div>

  <!-- MODAL CHAT -->
  <div class="modal fade" id="modalChat" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="tituloChat">Chat con el voluntario</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body" id="chatBody" style="height: 400px; overflow-y: auto;">
          <div class="text-center text-muted py-5" id="sinMensajes">Esperando mensajes...</div>
          <div id="typingIndicator" class="text-muted fst-italic ms-3 mb-2 d-none">Voluntario escribiendo...</div>
        </div>
        <div class="modal-footer">
          <div class="input-group">
            <input type="text" id="inputMensaje" class="form-control" placeholder="Escribe un mensaje..." autocomplete="off">
            <button class="btn btn-primary" id="btnEnviar">Enviar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- SONIDO DE NOTIFICACI√ìN -->
  <audio id="notificationSound" src="RECURSOS/noti.wav" preload="auto"></audio>

  <!-- SCRIPT PRINCIPAL -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      let data = JSON.parse(localStorage.getItem('emergenciaActiva'));

      if (!data || !data.alertaId) {
        alert("No se encontr√≥ datos de emergencia activa.");
        window.location.href = 'index.html';
        return;
      }

      // Mostrar coordenadas
      document.getElementById('coords').innerText = `Lat: ${data.lat.toFixed(6)}, Lng: ${data.lon.toFixed(6)}`;

      // Contador de tiempo activo
      const tiempoEl = document.getElementById('tiempoActivo');
      setInterval(() => {
        const mins = Math.floor((Date.now() - data.timestamp) / 60000);
        const secs = Math.floor(((Date.now() - data.timestamp) % 60000) / 1000);
        tiempoEl.innerText = `Activada hace ${mins}m ${secs}s`;
      }, 1000);
    });

    // Tus funciones de gu√≠a de primeros auxilios (mant√©n tu c√≥digo original aqu√≠)
    const guias = {
      paro: [
        "Verifica si la persona responde (llama y sacude suavemente)",
        "Si no responde, pide ayuda y llama al 123 o emergencias",
        "Coloca a la persona boca arriba en superficie firme",
        "Inicia compresiones tor√°cicas: 100-120 por minuto, profundidad 5-6 cm",
        "Si est√°s capacitado, combina con ventilaciones (30:2)",
        "Contin√∫a hasta que llegue ayuda profesional o use DEA"
      ],
      asfixia: [
        "Pregunta: ¬øPuedes hablar o toser?",
        "Si no responde, da 5 golpes fuertes entre los om√≥platos",
        "Si no funciona, realiza 5 compresiones abdominales (maniobra de Heimlich)",
        "Alterna golpes y compresiones hasta liberar la v√≠a a√©rea",
        "Si pierde el conocimiento, inicia RCP"
      ],
      hemorragia: [
        "Aplica presi√≥n directa firme sobre la herida con tela limpia",
        "Eleva la extremidad afectada por encima del coraz√≥n si es posible",
        "No retires objetos incrustados, presiona alrededor",
        "Si la sangre empapa la tela, coloca otra encima sin quitar la primera",
        "Mant√©n presi√≥n hasta llegada de ayuda m√©dica"
      ],
      otra: [
        "Mant√©n la calma y eval√∫a la seguridad de la escena",
        "Llama inmediatamente al 123 o emergencias locales",
        "No muevas a la persona si sospechas lesi√≥n en columna",
        "Proporciona confort y monitorea signos vitales",
        "Sigue instrucciones del operador de emergencias"
      ]
    };

    let tipoActual = "";
    let pasoActual = 0;

    function abrirGuia() {
      document.getElementById("tituloModal").innerText = "Selecciona tipo de emergencia";
      document.getElementById("contenidoModal").innerHTML = `
        <div class="row g-3 text-center">
          <div class="col-6">
            <button class="btn btn-outline-danger w-100 p-4 fs-5" onclick="iniciarPasos('paro')">
              ü´Ä Paro Card√≠aco
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-outline-primary w-100 p-4 fs-5" onclick="iniciarPasos('asfixia')">
              üòÆ‚Äçüí® Asfixia
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-outline-warning w-100 p-4 fs-5" onclick="iniciarPasos('hemorragia')">
              ü©∏ Hemorragia Grave
            </button>
          </div>
          <div class="col-6">
            <button class="btn btn-outline-secondary w-100 p-4 fs-5" onclick="iniciarPasos('otra')">
              ‚ö†Ô∏è Otra Emergencia
            </button>
          </div>
        </div>
      `;

      new bootstrap.Modal(document.getElementById('modalGuia')).show();
    }

    function iniciarPasos(tipo) {
      tipoActual = tipo;
      pasoActual = 0;
      renderPaso();
    }

    function renderPaso() {
      const pasos = guias[tipoActual];

      document.getElementById("tituloModal").innerText = 
        tipoActual.charAt(0).toUpperCase() + tipoActual.slice(1) + " - Paso " + (pasoActual + 1) + "/" + pasos.length;

      document.getElementById("contenidoModal").innerHTML = `
        <div class="text-center">
          <div class="alert alert-danger py-4 mb-4">
            <h4 class="alert-heading">Paso ${pasoActual + 1}</h4>
            <p class="fs-5 fw-bold">${pasos[pasoActual]}</p>
          </div>

          <div class="d-flex justify-content-between align-items-center">
            <button class="btn btn-outline-secondary" onclick="abrirGuia()">
              Cambiar tipo
            </button>

            <div>
              <button class="btn btn-secondary me-2" onclick="anteriorPaso()" ${pasoActual === 0 ? "disabled" : ""}>
                ‚Üê Anterior
              </button>
              <button class="btn btn-danger" onclick="siguientePaso()" ${pasoActual === pasos.length - 1 ? "disabled" : ""}>
                Siguiente ‚Üí
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function siguientePaso() {
      if (pasoActual < guias[tipoActual].length - 1) {
        pasoActual++;
        renderPaso();
      }
    }

    function anteriorPaso() {
      if (pasoActual > 0) {
        pasoActual--;
        renderPaso();
      }
    }

    function cancelarEmergencia() {
      if (confirm("¬øEst√°s seguro de cancelar la emergencia? Esto notificar√° a los voluntarios.")) {
        // La l√≥gica real est√° en el script type="module" de abajo
        window.dispatchEvent(new CustomEvent('cancelarEmergenciaManual'));
      }
    }
  </script>

  <!-- SCRIPT DEL CHAT + NOTIFICACI√ìN DE ACEPTACI√ìN -->
  <script type="module">
    import { db } from './SCRIPT/firebase-init.js';
    import { collection, addDoc, onSnapshot, orderBy, query, serverTimestamp, doc, updateDoc, deleteField } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    let alertaIdActual = null;
    let unsubscribeChat = null;
    let unsubscribeTyping = null;
    let unsubscribeAceptacion = null;
    let typingTimeout = null;
    const notificationSound = document.getElementById('notificationSound');

    document.addEventListener('DOMContentLoaded', () => {
      const data = JSON.parse(localStorage.getItem('emergenciaActiva'));
      if (data && data.alertaId) {
        alertaIdActual = data.alertaId;

        document.getElementById('btnAbrirChat').onclick = () => {
          document.getElementById('tituloChat').innerText = "Chat con el voluntario";
          const modal = new bootstrap.Modal(document.getElementById('modalChat'));
          modal.show();
          cargarMensajes();
          escucharTyping();
        };

        // Escuchar aceptaci√≥n del voluntario
        escucharAceptacion();
      }
    });

    function cargarMensajes() {
      if (!alertaIdActual) return;
      if (unsubscribeChat) unsubscribeChat();

      let lastMessageCount = 0;

      const q = query(collection(db, "alertas", alertaIdActual, "mensajes"), orderBy("timestamp"));

      unsubscribeChat = onSnapshot(q, (snapshot) => {
        const chatBody = document.getElementById('chatBody');
        chatBody.innerHTML = snapshot.empty ? 
          '<div class="text-center text-muted py-5" id="sinMensajes">Esperando mensajes...</div>' : '';

        snapshot.forEach((docSnap) => {
          const msg = docSnap.data();
          const div = document.createElement('div');
          div.className = `mb-3 ${msg.esVoluntario ? 'text-end' : 'text-start'}`;
          div.innerHTML = `
            <div class="d-inline-block p-3 rounded ${msg.esVoluntario ? 'bg-primary text-white' : 'bg-light'}"
                 style="max-width: 80%; border-radius: 18px;">
              <small class="d-block opacity-75">${msg.esVoluntario ? 'Voluntario' : 'T√∫'}</small>
              <p class="mb-1">${msg.texto}</p>
              <small class="d-block mt-1 opacity-75" style="font-size: 0.7em;">
                ${msg.timestamp?.toDate()?.toLocaleTimeString('es-CO') || 'Enviando...'}
              </small>
            </div>
          `;
          chatBody.appendChild(div);
        });

        chatBody.scrollTop = chatBody.scrollHeight;

        // Sonido al recibir mensaje del voluntario
        if (snapshot.size > lastMessageCount) {
          const newMsg = snapshot.docs[snapshot.size - 1].data();
          if (newMsg.esVoluntario) {
            notificationSound.play().catch(() => {});
          }
          lastMessageCount = snapshot.size;
        }
      });
    }

    function escucharTyping() {
      if (!alertaIdActual) return;
      if (unsubscribeTyping) unsubscribeTyping();

      const alertaRef = doc(db, "alertas", alertaIdActual);

      unsubscribeTyping = onSnapshot(alertaRef, (snap) => {
        const data = snap.data() || {};
        const indicator = document.getElementById('typingIndicator');
        if (data.isTypingVoluntario) {
          indicator.classList.remove('d-none');
        } else {
          indicator.classList.add('d-none');
        }
      });
    }

    function escucharAceptacion() {
      if (!alertaIdActual) return;
      const alertaRef = doc(db, "alertas", alertaIdActual);

      unsubscribeAceptacion = onSnapshot(alertaRef, (snap) => {
        const data = snap.data();
        if (data?.estado === "asignada" && data.voluntarioNombre) {
          // Actualizar localStorage con el nombre del voluntario
          let emergenciaData = JSON.parse(localStorage.getItem('emergenciaActiva'));
          emergenciaData.voluntarioNombre = data.voluntarioNombre;
          localStorage.setItem('emergenciaActiva', JSON.stringify(emergenciaData));

          // Reproducir sonido y alerta solo la primera vez
          if (!localStorage.getItem('alertaAceptadaNotificada_' + alertaIdActual)) {
            notificationSound.play().catch(() => {});
            alert(`¬°Un voluntario acept√≥ tu alerta!\nNombre: ${data.voluntarioNombre}\nEst√° en camino para ayudarte.`);
            localStorage.setItem('alertaAceptadaNotificada_' + alertaIdActual, 'true');
          }

          // Redirigir a la p√°gina de voluntario encontrado
          window.location.href = 'Voluntario-encontrado.html';
        }
      });
    }

    // Indicador de escritura del paciente
    document.getElementById('inputMensaje')?.addEventListener('input', () => {
      if (!alertaIdActual) return;
      clearTimeout(typingTimeout);
      updateDoc(doc(db, "alertas", alertaIdActual), { isTypingPaciente: true });
      typingTimeout = setTimeout(() => {
        updateDoc(doc(db, "alertas", alertaIdActual), { isTypingPaciente: deleteField() });
      }, 3000);
    });

    // Enviar mensaje
    document.getElementById('btnEnviar')?.addEventListener('click', enviarMensaje);
    document.getElementById('inputMensaje')?.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') enviarMensaje();
    });

    async function enviarMensaje() {
      const input = document.getElementById('inputMensaje');
      const texto = input.value.trim();
      if (!texto || !alertaIdActual) return;

      try {
        await addDoc(collection(db, "alertas", alertaIdActual, "mensajes"), {
          texto,
          esVoluntario: false,
          timestamp: serverTimestamp()
        });
        input.value = '';
        updateDoc(doc(db, "alertas", alertaIdActual), { isTypingPaciente: deleteField() });
      } catch (error) {
        alert("Error al enviar mensaje");
        console.error(error);
      }
    }

    window.addEventListener('cancelarEmergenciaManual', async () => {
      const data = JSON.parse(localStorage.getItem('emergenciaActiva'));
      if (data && data.alertaId) {
        try {
          await deleteDoc(doc(db, "alertas", data.alertaId));
        } catch (error) {
          console.error("Error al eliminar alerta:", error);
        }
      }
      localStorage.removeItem('emergenciaActiva');
      alert("Emergencia cancelada correctamente.");
      window.location.href = 'index.html';
    });
</script>

<!-- Aseg√∫rate de importar deleteDoc en el script del chat -->
<script type="module">
  import { db } from './SCRIPT/firebase-init.js';
  import { 
    collection, addDoc, onSnapshot, orderBy, query, serverTimestamp, 
    doc, updateDoc, deleteField, deleteDoc  // ‚Üê A√ëADIR deleteDoc AQU√ç
  } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";
  
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <footer class="site-footer">
    <p>No reemplazamos ambulancias, las complementamos con ayuda ciudadana.</p>
    <p>&copy; 2025 VidaLink. All rights reserved.</p>
  </footer>
</body>
</html>