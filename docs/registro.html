<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Registrarme | VidaLink</title>
  <link rel="icon" type="image/png" href="../RECURSOS/vidalink.png">
  <link rel="stylesheet" href="../CSS/styles.css">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="bg-light">

  <nav class="navbar bg-body-tertiary navbar-compact">
    <div class="container-fluid">
      <div class="d-flex align-items-center gap-2">
        <img src="../RECURSOS/logo.png" alt="Logo" width="200" height="55">
      </div>
    </div>
  </nav>

  <main class="container py-5">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6 col-xl-5">
        <div class="card shadow-lg border-0 rounded-4 p-4 p-md-5">
          <div class="card-body">
            <h2 class="brand-title text-center mb-4">Crear cuenta en VidaLink</h2>
            <p class="text-muted text-center mb-5">
              Ingresa tus datos para registrarte y poder usar el bot√≥n SOS
            </p>

            <form id="formRegistro">
              <div class="row g-3">
                <!-- Primera fila: Nombres -->
                <div class="col-md-6">
                  <label for="primerNombre" class="form-label fw-bold">Primer nombre <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-lg" id="primerNombre" required>
                </div>
                <div class="col-md-6">
                  <label for="segundoNombre" class="form-label fw-bold">Segundo nombre</label>
                  <input type="text" class="form-control form-control-lg" id="segundoNombre">
                </div>

                <!-- Segunda fila: Apellidos -->
                <div class="col-md-6">
                  <label for="primerApellido" class="form-label fw-bold">Primer apellido <span class="text-danger">*</span></label>
                  <input type="text" class="form-control form-control-lg" id="primerApellido" required>
                </div>
                <div class="col-md-6">
                  <label for="segundoApellido" class="form-label fw-bold">Segundo apellido</label>
                  <input type="text" class="form-control form-control-lg" id="segundoApellido">
                </div>

                <!-- Celular -->
                <div class="col-12">
                  <label for="celular" class="form-label fw-bold">Celular <span class="text-danger">*</span></label>
                  <input type="tel" class="form-control form-control-lg" id="celular" placeholder="Ej: 3001234567" required>
                </div>

                <!-- Email y Contrase√±a -->
                <div class="col-12">
                  <label for="email" class="form-label fw-bold">Correo electr√≥nico <span class="text-danger">*</span></label>
                  <input type="email" class="form-control form-control-lg" id="email" required>
                </div>
                <div class="col-12">
                  <label for="password" class="form-label fw-bold">Contrase√±a <span class="text-danger">*</span></label>
                  <input type="password" class="form-control form-control-lg" id="password" required minlength="6">
                  <small class="text-muted">M√≠nimo 6 caracteres</small>
                </div>

                <!-- Checkbox voluntario (opcional) -->
                <div class="col-12">
                  <div class="form-check mt-3">
                    <input class="form-check-input" type="checkbox" id="esVoluntario">
                    <label class="form-check-label fw-bold" for="esVoluntario">
                      Quiero ser voluntario y ayudar en emergencias cercanas
                    </label>
                  </div>
                </div>

                <!-- Botones -->
                <div class="col-12 mt-4">
                  <button type="submit" class="btn btn-danger btn-lg w-100 fw-bold" id="btnRegistro">
                    <span class="spinner-border spinner-border-sm d-none" role="status" id="spinner"></span>
                    Registrarme
                  </button>
                </div>

                <div class="col-12 text-center mt-3">
                  <p class="mb-0">
                    ¬øYa tienes cuenta? 
                    <a href="login.html" class="text-danger fw-bold">Iniciar sesi√≥n</a>
                  </p>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </main>

  <script type="module">
    import { auth, db } from '../SCRIPT/firebase-init.js';
    import { createUserWithEmailAndPassword } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
    import { doc, setDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const form = document.getElementById('formRegistro');
    const btnRegistro = document.getElementById('btnRegistro');
    const spinner = document.getElementById('spinner');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const primerNombre = document.getElementById('primerNombre').value.trim();
      const segundoNombre = document.getElementById('segundoNombre').value.trim();
      const primerApellido = document.getElementById('primerApellido').value.trim();
      const segundoApellido = document.getElementById('segundoApellido').value.trim();
      const celular = document.getElementById('celular').value.trim();
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      const esVoluntario = document.getElementById('esVoluntario').checked;

      // Validaciones b√°sicas
      if (!primerNombre || !primerApellido || !celular || !email || !password) {
        alert("Por favor completa todos los campos obligatorios");
        return;
      }

      if (!/^\d{10}$/.test(celular.replace(/\s/g, ''))) {
        alert("El celular debe tener 10 d√≠gitos num√©ricos");
        return;
      }

      btnRegistro.disabled = true;
      spinner.classList.remove('d-none');

      try {
        // Crear usuario en Firebase Auth
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;

        // Guardar datos completos en Firestore
        await setDoc(doc(db, "usuarios", user.uid), {
          primerNombre,
          segundoNombre: segundoNombre || null,
          primerApellido,
          segundoApellido: segundoApellido || null,
          celular,
          email,
          esVoluntario,
          fechaRegistro: new Date()
        });

        alert("¬°Registro exitoso! Bienvenido a VidaLink üö®");
        window.location.href = 'index.html';

      } catch (error) {
        console.error("Error en registro:", error);
        let mensaje = "Error al crear la cuenta. ";
        if (error.code === 'auth/email-already-in-use') {
          mensaje += "Este correo ya est√° registrado.";
        } else if (error.code === 'auth/weak-password') {
          mensaje += "La contrase√±a es muy d√©bil.";
        } else {
          mensaje += "Int√©ntalo de nuevo.";
        }
        alert(mensaje);
      } finally {
        btnRegistro.disabled = false;
        spinner.classList.add('d-none');
      }
    });
  </script>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js"></script>

  <footer class="site-footer mt-5">
    <p>No reemplazamos ambulancias, las complementamos con ayuda ciudadana.</p>
    <p>&copy; 2025 VidaLink. All rights reserved.</p>
  </footer>
</body>
</html>